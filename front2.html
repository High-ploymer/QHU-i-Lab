<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QHU-i-Lab | 青海大学灵犀智约平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* 青海大学视觉识别系统 (VI) 配色 */
            --primary-color: #004ea2; /* 青大深蓝 */
            --secondary-color: #007bff; 
            --accent-color: #fdb913; /* 青大金黄 */
            --bg-color: #f4f6f9;
            --sidebar-width: 270px;
            --text-dark: #333;
            --text-light: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            
            /* 时间段网格配色 */
            --slot-bg: #fff;
            --slot-border: #dee2e6;
            --slot-hover: #e3f2fd;
            --slot-selected-bg: #004ea2;
            --slot-selected-text: #fff;
            --slot-disabled-bg: #f8f9fa;
            --slot-disabled-text: #adb5bd;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { background-color: var(--bg-color); min-height: 100vh; overflow-x: hidden; }

        /* =========================================
           1. 登录与注册界面样式 (Login Layer)
           ========================================= */
        #login-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: white; z-index: 10000;
            display: flex;
            transition: opacity 0.6s ease-in-out;
        }

        /* 左侧品牌区 */
        .login-brand {
            flex: 1;
            background: linear-gradient(135deg, rgba(0, 78, 162, 0.9), rgba(0, 30, 80, 0.95)), 
                        url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/cd/Qinghai_University_Gate.jpg/1200px-Qinghai_University_Gate.jpg');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; padding: 40px; position: relative; overflow: hidden;
        }
        .brand-deco { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.05); }
        .bd-1 { width: 400px; height: 400px; top: -100px; left: -100px; }
        .bd-2 { width: 600px; height: 600px; bottom: -200px; right: -200px; }
        
        .brand-logo { font-size: 70px; margin-bottom: 20px; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .brand-title h1 { font-size: 38px; letter-spacing: 3px; margin-bottom: 10px; font-weight: 700; }
        .brand-title p { font-size: 18px; opacity: 0.9; letter-spacing: 1px; font-weight: 300; }
        .brand-divider { width: 60px; height: 4px; background: var(--accent-color); margin: 25px 0; }

        /* 右侧表单区 */
        .login-form-container {
            width: 550px; background: white;
            display: flex; flex-direction: column; justify-content: center; padding: 60px;
            box-shadow: -10px 0 40px rgba(0,0,0,0.05);
            position: relative;
        }

        /* 登录/注册表单切换动画 */
        .auth-form { display: none; animation: fadeIn 0.4s; }
        .auth-form.active { display: block; }

        .login-header h2 { font-size: 32px; color: var(--primary-color); margin-bottom: 10px; }
        .login-header p { color: var(--text-light); font-size: 15px; margin-bottom: 30px; }

        .role-capsule {
            display: flex; background: #f1f3f5; padding: 5px; border-radius: 12px; margin-bottom: 30px;
        }
        .role-item {
            flex: 1; text-align: center; padding: 12px; border-radius: 8px; cursor: pointer;
            font-size: 14px; font-weight: 600; color: #666; transition: 0.3s;
        }
        .role-item.active { background: white; color: var(--primary-color); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .input-wrap { position: relative; margin-bottom: 25px; }
        .input-wrap i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #adb5bd; transition: 0.3s; z-index: 2; }
        /* 输入框样式 */
        .input-wrap input {
            width: 100%; padding: 16px 16px 16px 50px;
            border: 2px solid #f1f3f5; border-radius: 10px;
            font-size: 15px; background: #f8f9fa; transition: 0.3s; outline: none;
        }
        .input-wrap input:focus { border-color: var(--primary-color); background: white; box-shadow: 0 0 0 4px rgba(0, 78, 162, 0.1); }
        .input-wrap input:focus + i { color: var(--primary-color); }
        
        /* 下拉菜单样式适配 */
        .input-wrap select {
            width: 100%; padding: 16px 16px 16px 50px;
            border: 2px solid #f1f3f5; border-radius: 10px;
            font-size: 15px; background: #f8f9fa; transition: 0.3s; outline: none;
            appearance: none; -webkit-appearance: none; -moz-appearance: none; /* 移除默认箭头 */
            cursor: pointer;
        }
        .input-wrap select:focus { border-color: var(--primary-color); background: white; box-shadow: 0 0 0 4px rgba(0, 78, 162, 0.1); }
        .input-wrap select:invalid { color: #adb5bd; }
        /* 自定义下拉箭头 */
        .input-wrap::after {
            content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            color: #adb5bd; pointer-events: none; font-size: 12px;
        }
        /* 如果是 input 类型则不显示箭头 */
        .input-wrap:not(:has(select))::after { content: none; }


        .btn-submit {
            width: 100%; padding: 16px;
            background: var(--primary-color); color: white;
            border: none; border-radius: 10px;
            font-size: 16px; font-weight: 700; letter-spacing: 1px;
            cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-submit:hover { background: #003d80; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 78, 162, 0.3); }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        .switch-auth-link { text-align: center; margin-top: 20px; color: #666; font-size: 14px; }
        .switch-auth-link span { color: var(--secondary-color); cursor: pointer; font-weight: bold; }
        .switch-auth-link span:hover { text-decoration: underline; }

        .spinner {
            width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,0.3); border-top-color: white;
            border-radius: 50%; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* =========================================
           2. 主应用界面样式 (App Layer)
           ========================================= */
        #app-layer {
            display: none; /* JS 控制显示 */
            opacity: 0; transition: opacity 0.5s;
            display: flex; min-height: 100vh;
        }

        /* 侧边栏 */
        .sidebar {
            width: var(--sidebar-width); background: linear-gradient(180deg, var(--primary-color) 0%, #003366 100%);
            color: white; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }
        .logo-area { padding: 30px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo-icon-img { width: 50px; height: 50px; background: white; border-radius: 50%; padding: 2px; object-fit: contain; }
        .nav-menu { padding: 20px 0; flex: 1; }
        .nav-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 15px; color: rgba(255,255,255,0.8); border-left: 4px solid transparent; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; border-left-color: var(--accent-color); }

        /* 主内容 */
        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 30px; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 15px 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .user-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; position: relative; }
        .avatar { width: 40px; height: 40px; background: #ddd; border-radius: 50%; overflow: hidden; border: 2px solid #f0f0f0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .user-dropdown { position: absolute; top: 55px; right: 0; background: white; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); width: 220px; display: none; z-index: 500; padding: 5px 0; }
        .user-dropdown.show { display: block; }
        .dropdown-item { padding: 12px 20px; display: flex; align-items: center; gap: 10px; color: #333; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .dropdown-item:hover { background: #f8f9fa; color: var(--primary-color); }

        /* 统计卡片 */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-info h3 { font-size: 32px; color: var(--primary-color); margin-bottom: 5px; }
        .stat-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .icon-blue { background: #e3f2fd; color: #007bff; }
        .icon-green { background: #e8f5e9; color: #28a745; }
        .icon-yellow { background: #fff3e0; color: #ff9800; }
        .icon-red { background: #fbe9e7; color: #dc3545; }

        /* 内容卡片与列表 */
        .content-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 30px; }
        .section-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        
        .equipment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .equip-card { border: 1px solid #eee; border-radius: 10px; overflow: hidden; transition: 0.3s; background: white; display: flex; flex-direction: column; }
        .equip-card:hover { box-shadow: 0 10px 25px rgba(0,0,0,0.08); transform: translateY(-3px); }
        .equip-img { height: 160px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #adb5bd; position: relative; }
        
        .status-badge { position: absolute; top: 10px; right: 10px; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; }
        .bg-av { background: var(--success); } .bg-bk { background: var(--warning); } .bg-mt { background: var(--danger); }

        .equip-body { padding: 20px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .equip-title { font-weight: bold; margin-bottom: 8px; color: var(--text-dark); font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .equip-lab { font-size: 13px; color: var(--text-light); margin-bottom: 15px; display: flex; gap: 5px; }
        
        .action-btn { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: auto; }
        .btn-book { background: var(--secondary-color); color: white; } .btn-book:hover { background: #0056b3; }
        .btn-disabled { background: #e9ecef; color: #adb5bd; cursor: not-allowed; }

        /* 表格样式 */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { text-align: left; padding: 15px; border-bottom: 1px solid #eee; }
        .data-table th { color: var(--text-light); font-weight: 500; }
        .status-tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-pending { background: #fff3e0; color: #ff9800; }
        .status-approved { background: #e8f5e9; color: #28a745; }
        .status-cancelled { background: #e9ecef; color: #6c757d; text-decoration: line-through; }

        /* 管理员报修表格样式 */
        .admin-repair-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .admin-repair-table th { background: #f8f9fa; padding: 12px; text-align: left; color: #666; font-size: 14px; font-weight: 600; }
        .admin-repair-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .btn-fix { padding: 6px 15px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-fix:hover { background: #218838; }

        /* 静态入库页面表单样式 */
        .input-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-row label { display: block; margin-bottom: 8px; color: #666; font-weight: 500; font-size: 14px; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }

        /* 模态框通用 */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; animation: slideDown 0.3s; position: relative; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .close-btn { position: absolute; top: 20px; right: 20px; cursor: pointer; color: #999; }

        /* 时间段网格样式 */
        .time-slots-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 5px;
        }
        .time-slot {
            padding: 12px; background: var(--slot-bg); border: 1px solid var(--slot-border);
            border-radius: 6px; text-align: center; font-size: 13px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .time-slot:hover:not(.disabled) { border-color: var(--secondary-color); background-color: var(--slot-hover); color: var(--secondary-color); }
        .time-slot.selected { background-color: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 4px 10px rgba(0, 78, 162, 0.3); }
        /* 禁用状态 */
        .time-slot.disabled { background-color: var(--slot-disabled-bg); color: var(--slot-disabled-text); cursor: not-allowed; border-color: transparent; }
        .time-slot.disabled::after { content: '已约'; position: absolute; top: 2px; right: 2px; font-size: 10px; opacity: 0.6; }

        .chart-placeholder { width: 100%; height: 200px; background: linear-gradient(to right, #f8f9fa 50%, #e9ecef 50%); background-size: 40px 100%; border-radius: 8px; display: flex; align-items: flex-end; justify-content: space-around; padding-bottom: 20px; }
        .bar { width: 30px; background: var(--secondary-color); border-radius: 4px 4px 0 0; opacity: 0.7; }
        .bar-label { font-size: 10px; text-align: center; margin-top: 5px; color: #666; }

        /* 视图切换 */
        .view-section { display: none; animation: fadeIn 0.4s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Toast 提示 */
        .toast {
            display: none; position: fixed; bottom: 30px; right: 30px; background: white; padding: 15px 25px;
            border-left: 5px solid var(--success); box-shadow: 0 5px 20px rgba(0,0,0,0.2); border-radius: 4px; z-index: 2000;
        }

    </style>
</head>
<body>

    <div id="login-layer">
        <div class="login-brand">
            <div class="brand-deco bd-1"></div>
            <div class="brand-deco bd-2"></div>
            <img src="image/qhu_logo.png" class="brand-logo" style="width:100px; height:100px; object-fit:contain; border-radius:50%; background:white; padding:5px; margin-bottom:20px;" onerror="this.src='https://via.placeholder.com/100?text=QHU'">
            <div class="brand-title">
                <h1>青海大学</h1>
                <p>QINGHAI UNIVERSITY</p>
            </div>
            <div class="brand-divider"></div>
            <p style="font-size: 16px; opacity: 0.8;">青海大学灵犀智约平台</p>
        </div>

        <div class="login-form-container">
            <div id="form-login" class="auth-form active">
                <div class="login-header">
                    <h2>欢迎登录</h2>
                    <p>请使用校园统一身份认证账号 (学号/工号)</p>
                </div>

                <div class="role-capsule">
                    <div class="role-item active" id="role-Student" onclick="selectRole('Student')">
                        <i class="fa-solid fa-user-graduate"></i> 学生登录
                    </div>
                    <div class="role-item" id="role-Admin" onclick="selectRole('Admin')">
                        <i class="fa-solid fa-chalkboard-user"></i> 管理员登录
                    </div>
                </div>

                <form onsubmit="event.preventDefault(); attemptLogin();">
                    <div class="input-wrap">
                        <i class="fa-regular fa-user"></i>
                        <input type="text" id="loginId" placeholder="请输入学号/工号" required>
                    </div>
                    <div class="input-wrap">
                        <i class="fa-solid fa-lock"></i>
                        <input type="password" id="loginPwd" placeholder="请输入密码" required>
                    </div>

                    <button type="submit" class="btn-submit" id="loginBtn">
                        <span>立即登录</span>
                        <div class="spinner"></div>
                    </button>
                </form>

                <div class="switch-auth-link">
                    还没有账号？<span onclick="toggleAuth('register')">立即注册</span>
                </div>
            </div>

            <div id="form-register" class="auth-form">
                <div class="login-header">
                    <h2>注册新账号</h2>
                    <p>请填写您的真实信息完成注册</p>
                </div>

                <form onsubmit="event.preventDefault(); attemptRegister();">
                    <div class="input-wrap">
                        <i class="fa-solid fa-id-card"></i>
                        <input type="text" id="regUsername" placeholder="学号 (必须为12位数字)" required>
                    </div>
                    <div class="input-wrap">
                        <i class="fa-solid fa-lock"></i>
                        <input type="password" id="regPassword" placeholder="设置密码" required>
                    </div>
                    <div class="input-wrap">
                        <i class="fa-regular fa-user"></i>
                        <input type="text" id="regRealName" placeholder="真实姓名 (必须为中文)" required>
                    </div>
                    <div class="input-wrap">
                        <i class="fa-solid fa-building-columns"></i>
                        <select id="regDept" required>
                            <option value="" disabled selected>请选择所属院系</option>
                            <option value="计算机技术与应用系">计算机技术与应用系</option>
                            <option value="医学院">医学院</option>
                            <option value="农牧学院">农牧学院</option>
                            <option value="化工学院">化工学院</option>
                            <option value="财经学院">财经学院</option>
                            <option value="机械工程学院">机械工程学院</option>
                            <option value="土木水利学院">土木水利学院</option>
                            <option value="生态环境工程学院">生态环境工程学院</option>
                            <option value="藏医学院">藏医学院</option>
                            <option value="马克思主义学院">马克思主义学院</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-submit" id="regBtn">
                        <span>确认注册</span>
                        <div class="spinner"></div>
                    </button>
                </form>

                <div class="switch-auth-link">
                    已有账号？<span onclick="toggleAuth('login')">返回登录</span>
                </div>
            </div>

            <div style="margin-top: 25px; text-align: center; color: #999; font-size: 13px;">
                © 2025 计算机技术与应用系 · 数据库课程设计组
            </div>
        </div>
    </div>

    <div id="app-layer">
        <aside class="sidebar">
            <div class="logo-area">
                <img src="image/qhu_logo.png" class="logo-icon-img" onerror="this.src='https://via.placeholder.com/50?text=QHU'">
                <div style="margin-left: 10px;">
                    <h2 style="font-size: 18px; letter-spacing: 1px;">青海大学</h2>
                    <p style="font-size: 10px; opacity: 0.6;">LAB MANAGEMENT</p>
                </div>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" onclick="switchView('view-dashboard', this)">
                    <i class="fa-solid fa-gauge-high"></i> 系统概览
                </div>
                <div class="nav-item" onclick="switchView('view-booking', this)">
                    <i class="fa-solid fa-microscope"></i> 科研设备预约
                </div>
                <div class="nav-item" onclick="switchView('view-computer-rooms', this)">
                    <i class="fa-solid fa-desktop"></i> 计算机房预约
                </div>
                <div class="nav-item" onclick="switchView('view-my-apps', this)">
                    <i class="fa-solid fa-list-check"></i> 我的申请
                </div>
                <div class="nav-item" onclick="switchView('view-repair-report', this)">
                    <i class="fa-solid fa-screwdriver-wrench"></i> 故障报修
                </div>
                
                <div id="admin-menu-area" style="display: none;">
                    <div style="margin-top: 30px; padding: 0 25px; font-size: 12px; opacity: 0.5;">管理员控制台</div>
                    <div class="nav-item" onclick="switchView('view-admin-repair', this)">
                        <i class="fa-solid fa-hammer"></i> 报修处理 <span id="repairBadge" style="background:red; font-size:10px; padding:2px 6px; border-radius:10px; margin-left:5px;">0</span>
                    </div>
                    <div class="nav-item" onclick="switchView('view-admin-import', this)">
                        <i class="fa-solid fa-server"></i> 设备入库
                    </div>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div class="breadcrumb" id="pageTitle">
                    <i class="fa-solid fa-house"></i> 首页 / <strong>系统概览</strong>
                </div>
                
                <div class="user-profile" onclick="toggleUserMenu()">
                    <div style="text-align: right; margin-right: 10px;">
                        <div style="font-weight: bold; font-size: 14px; color: #333;" id="navUserName">加载中...</div>
                        <div style="font-size: 12px; color: #888;" id="navUserDept">加载中...</div>
                    </div>
                    <div class="avatar">
                        <img src="" id="navUserAvatar" alt="Avatar">
                    </div>
                    <i class="fa-solid fa-caret-down" style="color:#999; font-size: 12px;"></i>

                    <div class="user-dropdown" id="userMenu">
                        <div class="dropdown-item"><i class="fa-regular fa-id-card"></i> 个人中心</div>
                        <div class="dropdown-item"><i class="fa-solid fa-key"></i> 修改密码</div>
                        <div style="height:1px; background:#eee; margin:5px 0;"></div>
                        <div class="dropdown-item" onclick="logout()" style="color: var(--danger);">
                            <i class="fa-solid fa-right-from-bracket"></i> 退出登录
                        </div>
                    </div>
                </div>
            </header>

            <div id="view-dashboard" class="view-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div><h3 id="dashTotal">--</h3><p style="color:#888">设备总数</p></div>
                        <i class="fa-solid fa-cube icon-blue" style="font-size:30px;"></i>
                    </div>
                    <div class="stat-card">
                        <div><h3 id="dashAvailable">--</h3><p style="color:#888">当前可用</p></div>
                        <i class="fa-regular fa-calendar-check icon-green" style="font-size:30px;"></i>
                    </div>
                    <div class="stat-card">
                        <div><h3 id="dashToday">--</h3><p style="color:#888">今日预约</p></div>
                        <i class="fa-regular fa-clock icon-yellow" style="font-size:30px;"></i>
                    </div>
                    <div class="stat-card" onclick="adminRedirect()" style="cursor: pointer;">
                        <div><h3 id="dashRepair">--</h3><p style="color:#888">待维修</p></div>
                        <i class="fa-solid fa-triangle-exclamation icon-red" style="font-size:30px;"></i>
                    </div>
                </div>
                
                <div class="content-card">
                    <h3><i class="fa-solid fa-bullhorn"></i> 近期公告</h3>
                    <div style="margin-top: 15px; color: #555; line-height: 1.8;">
                        <p>• [通知] 高性能计算中心 A100 服务器集群将于本周六 (12.28) 进行例行维护，请提前保存数据。</p>
                        <p>• [排课] 计算机系 121 机房新学期排课表已更新，请在“计算机房预约”模块查看优先时段。</p>
                        <p>• [安全] 实验室安全检查将于下周一开始，请各实验室负责人做好准备。</p>
                    </div>
                </div>
            </div>

            <div id="view-booking" class="view-section">
                <div class="content-card">
                    <div class="section-header">
                        <h3><i class="fa-solid fa-filter"></i> 设备列表</h3>
                        <div style="background: #f8f9fa; padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 10px; border: 1px solid #eee;">
                            <i class="fa-solid fa-magnifying-glass" style="color:#999"></i>
                            <input type="text" placeholder="搜索设备名称..." onkeyup="filterList(this.value, 'equipGrid')" style="border:none; background:transparent; outline:none;">
                        </div>
                    </div>
                    <div class="equipment-grid" id="equipGrid">
                        <div style="padding:20px; color:#666;">正在连接数据库加载设备列表...</div>
                    </div>
                </div>
            </div>

            <div id="view-computer-rooms" class="view-section">
                <div class="content-card">
                    <div class="section-header">
                        <h3><i class="fa-solid fa-desktop"></i> 机房列表</h3>
                        <p style="font-size: 13px; color: #666;">* 121、223 机房晚间优先大一班级使用</p>
                    </div>
                    <div class="equipment-grid" id="computerGrid">
                        </div>
                </div>
            </div>

            <div id="view-my-apps" class="view-section">
                <div class="content-card">
                    <h3><i class="fa-solid fa-list-check"></i> 我的申请记录</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>设备/机房名称</th>
                                <th>预约日期</th>
                                <th>时间段</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="myAppsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="view-repair-report" class="view-section">
                <div class="content-card" style="max-width: 800px;">
                    <h3 style="color: var(--danger); margin-bottom: 20px;"><i class="fa-solid fa-triangle-exclamation"></i> 提交故障报修单</h3>
                    <div class="form-row" style="margin-bottom: 20px;">
                        <label>选择故障设备</label>
                        <select id="repairEquipSelect" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="">-- 请选择设备 --</option>
                            </select>
                    </div>
                    <div class="form-row" style="margin-bottom: 20px;">
                        <label>故障现象描述</label>
                        <textarea id="repairDesc" rows="5" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;" placeholder="请详细描述故障现象，例如：无法开机、屏幕闪烁、软件报错等..."></textarea>
                    </div>
                    <div class="form-row" style="margin-bottom: 20px;">
                        <label>紧急程度</label>
                        <select id="repairUrgency" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="Normal">一般 (Normal)</option>
                            <option value="Urgent">紧急 (Urgent) - 影响科研进度</option>
                        </select>
                    </div>
                    <div style="text-align: right;">
                        <button onclick="submitRepair()" style="background: var(--danger); color: white; padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            <i class="fa-solid fa-paper-plane"></i> 提交报修
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-admin-repair" class="view-section">
                <div class="content-card">
                    <h3><i class="fa-solid fa-hammer"></i> 待处理报修单</h3>
                    <table class="admin-repair-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">报修人</th>
                                <th style="width: 20%;">故障设备</th>
                                <th style="width: 35%;">问题描述</th>
                                <th style="width: 15%;">时间</th>
                                <th style="width: 15%;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="adminRepairList">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="view-admin-import" class="view-section">
                <div class="content-card">
                    <h3 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fa-solid fa-plus-circle"></i> 新设备入库登记</h3>
                    <div class="input-form-grid">
                        <div class="form-row">
                            <label>设备名称</label>
                            <input type="text" placeholder="例如: 高性能 GPU 服务器">
                        </div>
                        <div class="form-row">
                            <label>所属实验室</label>
                            <select>
                                <option>青海省智能计算与应用实验室</option>
                                <option>高性能计算中心</option>
                                <option>水利水电工程实验室</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>设备类别</label>
                            <select>
                                <option>科研设备 (Device)</option>
                                <option>计算机房 (ComputerRoom)</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>资产编号</label>
                            <input type="text" placeholder="QHU-2025-XXXX">
                        </div>
                        <div class="form-row">
                            <label>采购日期</label>
                            <input type="date">
                        </div>
                        <div class="form-row">
                            <label>负责人</label>
                            <input type="text" value="管理员">
                        </div>
                    </div>
                    <div style="margin-top: 30px; text-align: right;">
                        <button onclick="alert('【演示模式】入库单已生成，等待资产处审核！')" style="padding: 12px 40px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            <i class="fa-solid fa-check"></i> 确认入库
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div class="modal" id="bookingModal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('bookingModal')"><i class="fa-solid fa-xmark"></i></div>
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">
                <i class="fa-regular fa-calendar-plus"></i> 新建预约申请
            </h3>
            
            <input type="hidden" id="modalEquipId">
            <input type="hidden" id="modalSelectedSlot">

            <div class="form-row" style="margin-bottom: 15px;">
                <label>预约设备/机房</label>
                <input type="text" id="modalEquipName" disabled style="background:#f9f9f9; width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
            </div>
            <div class="form-row" style="margin-bottom: 15px;">
                <label>所属实验室</label>
                <input type="text" id="modalLabName" disabled style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
            </div>
            
            <div class="form-row" style="margin-bottom: 15px;">
                <label><i class="fa-regular fa-calendar"></i> 选择日期</label>
                <input type="date" id="modalDateInput" onchange="refreshTimeSlots()" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
            </div>
            
            <div class="form-row" style="margin-bottom: 15px;">
                <label><i class="fa-regular fa-clock"></i> 选择时间段</label>
                <div class="time-slots-grid" id="slotContainer">
                    <div style="grid-column: 1/-1; text-align: center; color: #999; font-size: 13px;">请先选择日期</div>
                </div>
                <div id="slotErrorMsg" style="color:var(--danger); font-size:12px; display:none; margin-top:5px;">请先选择一个可用的时间段</div>
            </div>

            <div class="form-row" style="margin-bottom: 20px;">
                <label>用途简述</label>
                <textarea id="modalReason" rows="3" placeholder="请简述实验目的..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('bookingModal')" style="padding: 10px 20px; border:1px solid #ddd; background:white; border-radius:6px; cursor:pointer;">取消</button>
                <button onclick="confirmBooking()" style="padding: 10px 20px; border:none; background:var(--primary-color); color:white; border-radius:6px; cursor:pointer;">确认提交</button>
            </div>
        </div>
    </div>

    <div class="toast" id="successToast">
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fa-solid fa-circle-check" style="color: var(--success); font-size: 20px;"></i>
            <div>
                <h4 style="margin:0; font-size:16px;">操作成功</h4>
                <p style="margin:0; font-size:12px; color:#666;" id="toastMsg">预约已提交</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:5000";
        let currentUser = null;
        let currentRole = 'Student';

        const TIME_SLOTS = [
            { id: 1, text: "08:00 - 10:00" },
            { id: 2, text: "10:00 - 12:00" },
            { id: 3, text: "14:00 - 16:00" },
            { id: 4, text: "16:00 - 18:00" },
            { id: 5, text: "19:00 - 21:00 (晚)" }
        ];

        // 1. 初始化
        window.addEventListener('DOMContentLoaded', () => {
            const storedUser = localStorage.getItem('qhu_user');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                initApp();
            } else {
                document.getElementById('login-layer').style.opacity = '1';
            }
        });

        // 2. 登录/注册切换
        function toggleAuth(view) {
            document.querySelectorAll('.auth-form').forEach(el => el.classList.remove('active'));
            document.getElementById('form-' + view).classList.add('active');
        }
        function selectRole(role) {
            currentRole = role;
            document.querySelectorAll('.role-item').forEach(el => el.classList.remove('active'));
            document.getElementById('role-' + role).classList.add('active');
        }

        // 3. 登录请求
        async function attemptLogin() {
            const btn = document.getElementById('loginBtn');
            const spinner = btn.querySelector('.spinner');
            const btnText = btn.querySelector('span');
            
            btn.disabled = true; btnText.style.display = 'none'; spinner.style.display = 'block';

            try {
                const res = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: document.getElementById('loginId').value,
                        password: document.getElementById('loginPwd').value,
                        role: currentRole
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('qhu_user', JSON.stringify(currentUser));
                    initApp();
                } else {
                    alert('登录失败: ' + (data.error || '未知错误'));
                }
            } catch (e) { alert('连接后端失败，请检查 app.py 是否运行'); } 
            finally {
                btn.disabled = false; btnText.style.display = 'block'; spinner.style.display = 'none';
            }
        }

        // 4. 注册请求
        async function attemptRegister() {
            const username = document.getElementById('regUsername').value;
            const realName = document.getElementById('regRealName').value;
            const dept = document.getElementById('regDept').value;
            const password = document.getElementById('regPassword').value;

            // 验证学号：12位纯数字
            if (!/^\d{12}$/.test(username)) {
                alert("格式错误：学号必须是 12 位纯数字！");
                return;
            }

            // 验证姓名：纯中文
            if (!/^[\u4e00-\u9fa5]+$/.test(realName)) {
                alert("格式错误：真实姓名必须是中文！");
                return;
            }

            // 验证院系：必选
            if (!dept) {
                alert("请选择所属院系！");
                return;
            }

            const payload = {
                username: username,
                password: password,
                real_name: realName,
                department: dept
            };
            
            const res = await fetch(`${API_BASE}/api/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.success) {
                alert('注册成功！请登录');
                toggleAuth('login');
            } else {
                alert('注册失败: ' + data.error);
            }
        }

        // 5. 初始化主界面
        function initApp() {
            document.getElementById('login-layer').style.display = 'none';
            document.getElementById('app-layer').style.display = 'flex';
            setTimeout(() => document.getElementById('app-layer').style.opacity = '1', 10);

            // 设置用户信息
            document.getElementById('navUserName').innerText = currentUser.real_name;
            document.getElementById('navUserDept').innerText = currentUser.department;
            
            const avatarSrc = currentUser.role === 'Admin' ? 'image/admin_avatar.png' : 'image/student_avatar.png';
            const imgEl = document.getElementById('navUserAvatar');
            imgEl.src = avatarSrc;
            imgEl.onerror = function() {
                this.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.username}`;
            };

            // 权限控制与数据加载
            if (currentUser.role === 'Admin') {
                document.getElementById('admin-menu-area').style.display = 'block';
                loadAdminRepairs(); 
            } else {
                document.getElementById('admin-menu-area').style.display = 'none';
                loadEquipOptions(); 
            }

            loadEquipments();
            loadDashboardStats(); // [新功能] 加载动态概览
        }

        // [新功能] 加载系统概览动态数据
        async function loadDashboardStats() {
            const res = await fetch(`${API_BASE}/api/dashboard_stats`);
            const data = await res.json();
            
            document.getElementById('dashTotal').innerText = data.total_equip;
            document.getElementById('dashAvailable').innerText = data.available_equip;
            document.getElementById('dashToday').innerText = data.today_bookings;
            document.getElementById('dashRepair').innerText = data.maintenance_equip;
            
            // 如果是学生端，虽然看不到数字变化，但数字会更新
        }

        // 6. 加载设备列表
        async function loadEquipments() {
            try {
                const res = await fetch(`${API_BASE}/api/equipments`);
                const data = await res.json();
                
                const computers = data.filter(d => d.category === 'ComputerRoom');
                const devices = data.filter(d => d.category !== 'ComputerRoom');

                renderList(devices, 'equipGrid');
                renderList(computers, 'computerGrid');
            } catch(e) { console.error(e); }
        }

        function renderList(data, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            data.forEach(item => {
                let statusClass = 'bg-av', statusText = '正常', btnHtml = '';
                
                // [新功能] 状态联动：维修中状态
                if (item.status === 'Maintenance') {
                    statusClass = 'bg-mt'; statusText = '维修中';
                    btnHtml = `<button class="action-btn btn-disabled">暂停预约</button>`;
                } else {
                    const nameSafe = item.name.replace(/'/g, "\\'");
                    const labSafe = item.lab.replace(/'/g, "\\'");
                    btnHtml = `<button class="action-btn btn-book" onclick="openBookingModal('${item.id}', '${nameSafe}', '${labSafe}')">立即预约</button>`;
                }

                container.innerHTML += `
                    <div class="equip-card">
                        <div class="equip-img">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <i class="fa-solid ${item.icon || 'fa-cube'}"></i>
                        </div>
                        <div class="equip-body">
                            <div class="equip-title" title="${item.name}">${item.name}</div>
                            <div class="equip-lab"><i class="fa-solid fa-location-dot"></i> ${item.lab}</div>
                            ${item.detail ? `<div style="font-size:12px; color:#999; margin-bottom:10px;">${item.detail}</div>` : ''}
                            ${btnHtml}
                        </div>
                    </div>
                `;
            });
        }

        // 7. 预约流程
        function openBookingModal(id, name, lab) {
            document.getElementById('bookingModal').style.display = 'flex';
            document.getElementById('modalEquipId').value = id;
            document.getElementById('modalEquipName').value = name;
            document.getElementById('modalLabName').value = lab;
            document.getElementById('modalDateInput').value = new Date().toISOString().split('T')[0];
            document.getElementById('slotContainer').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999">请选择日期</div>';
            refreshTimeSlots();
        }

        async function refreshTimeSlots() {
            const date = document.getElementById('modalDateInput').value;
            const equipId = document.getElementById('modalEquipId').value;
            const container = document.getElementById('slotContainer');
            
            if(!date) return;
            container.innerHTML = '加载中...';

            const res = await fetch(`${API_BASE}/api/availability?equipment_id=${equipId}&date=${date}`);
            const data = await res.json();
            const booked = data.booked_slots || [];

            container.innerHTML = '';
            TIME_SLOTS.forEach(slot => {
                const isTaken = booked.includes(slot.id);
                const div = document.createElement('div');
                div.className = `time-slot ${isTaken ? 'disabled' : ''}`;
                div.innerText = slot.text;
                if(!isTaken) {
                    div.onclick = () => {
                        document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
                        div.classList.add('selected');
                        document.getElementById('modalSelectedSlot').value = slot.id;
                    };
                }
                container.appendChild(div);
            });
        }

        async function confirmBooking() {
            const slotId = document.getElementById('modalSelectedSlot').value;
            if(!slotId) { alert('请选择时间段'); return; }

            const payload = {
                user_id: currentUser.user_id,
                equipment_id: document.getElementById('modalEquipId').value,
                date: document.getElementById('modalDateInput').value,
                slot_id: slotId,
                reason: document.getElementById('modalReason').value
            };

            const res = await fetch(`${API_BASE}/api/book`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
            });
            
            if(res.ok) {
                showToast('预约成功');
                closeModal('bookingModal');
                loadMyBookings();
                loadDashboardStats(); // 刷新概览数字
            } else {
                alert('预约失败');
            }
        }

        // 8. 学生报修功能 (含重复拦截)
        async function submitRepair() {
            const equipId = document.getElementById('repairEquipSelect').value;
            if(!equipId) { alert('请选择故障设备'); return; }

            try {
                const res = await fetch(`${API_BASE}/api/report_repair`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUser.user_id,
                        equip_id: equipId,
                        issue_desc: document.getElementById('repairDesc').value,
                        urgency: document.getElementById('repairUrgency').value
                    })
                });
                
                if (res.ok) {
                    showToast('报修单已成功提交！');
                    document.getElementById('repairDesc').value = '';
                    loadEquipments(); // 刷新列表状态
                    loadDashboardStats(); // 刷新概览
                } else if (res.status === 409) {
                    // [新功能] 重复报修拦截提示
                    alert('⚠️ 提交失败：该设备已存在未处理的报修单，管理员正在路上，请勿重复提交！');
                } else {
                    alert('提交失败，请重试');
                }
            } catch (e) {
                alert('网络错误，提交失败');
            }
        }

        async function loadEquipOptions() {
            const res = await fetch(`${API_BASE}/api/equipments`);
            const data = await res.json();
            const sel = document.getElementById('repairEquipSelect');
            sel.innerHTML = '<option value="">-- 请选择设备 --</option>'; 
            data.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.innerText = e.name;
                sel.appendChild(opt);
            });
        }

        // 9. 管理员报修处理功能
        async function loadAdminRepairs() {
            const res = await fetch(`${API_BASE}/api/admin/repairs`);
            const data = await res.json();
            const tbody = document.getElementById('adminRepairList');
            tbody.innerHTML = '';
            
            let pendingCount = 0;
            data.forEach(r => {
                if(r.status !== 'Fixed') {
                    pendingCount++;
                    tbody.innerHTML += `
                        <tr>
                            <td>${r.reporter}</td>
                            <td>${r.equip_name}</td>
                            <td style="color:var(--danger)">${r.issue_desc}</td>
                            <td>${r.report_date}</td>
                            <td><button class="btn-fix" onclick="fixRepair(${r.repair_id})">标记已修</button></td>
                        </tr>
                    `;
                }
            });
            document.getElementById('repairBadge').innerText = pendingCount;
        }

        async function fixRepair(id) {
            if(confirm('确认设备已修复？系统将自动通知学生。')) {
                await fetch(`${API_BASE}/api/admin/fix_repair`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ repair_id: id, reply: '已现场修复' })
                });
                showToast('处理完成');
                loadAdminRepairs();
                loadDashboardStats();
            }
        }

        // 10. 我的申请列表 (支持取消)
        async function loadMyBookings() {
            const res = await fetch(`${API_BASE}/api/my-bookings?user_id=${currentUser.user_id}`);
            const data = await res.json();
            const tbody = document.getElementById('myAppsTableBody');
            tbody.innerHTML = '';
            
            data.forEach(r => {
                const slotText = TIME_SLOTS.find(s => s.id == r.slot_id)?.text || "未知";
                // 状态样式处理
                let statusBadge = `<span class="status-tag status-approved">${r.status}</span>`;
                let actionBtn = `<button onclick="cancelBooking(${r.app_id})" style="color:var(--danger); border:none; background:none; cursor:pointer; text-decoration:underline;">取消预约</button>`;

                if(r.status === 'Cancelled') {
                    statusBadge = `<span class="status-tag status-cancelled">已取消</span>`;
                    actionBtn = `<span style="color:#999; font-size:12px;">无法操作</span>`;
                } else if (r.status === 'Completed') {
                     actionBtn = `<span style="color:#999; font-size:12px;">已完成</span>`;
                }

                tbody.innerHTML += `<tr><td>${r.equip_name}</td><td>${r.booking_date}</td><td>${slotText}</td><td>${statusBadge}</td><td>${actionBtn}</td></tr>`;
            });
        }

        // [新功能] 取消预约
        async function cancelBooking(appId) {
            if(!confirm("确定要取消这条预约申请吗？")) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/cancel_booking`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ app_id: appId })
                });
                
                if(res.ok) {
                    showToast('预约已取消');
                    loadMyBookings();
                    loadDashboardStats(); // 释放了名额，刷新今日预约数
                } else {
                    const err = await res.json();
                    alert(err.error || '取消失败');
                }
            } catch(e) { alert('网络错误'); }
        }

        // 11. 通用辅助
        function switchView(id, el) {
            document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
            if(id === 'view-my-apps') loadMyBookings();
            if(id === 'view-admin-repair') loadAdminRepairs();
            if(id === 'view-dashboard') loadDashboardStats();
        }

        function adminRedirect() {
            if(currentUser && currentUser.role === 'Admin') switchView('view-admin-repair');
        }

        function logout() {
            localStorage.removeItem('qhu_user');
            location.reload();
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function toggleUserMenu() { document.getElementById('userMenu').classList.toggle('show'); }
        window.onclick = e => { if(!e.target.closest('.user-profile')) document.getElementById('userMenu').classList.remove('show'); }

        function showToast(msg) {
            const t = document.getElementById('successToast');
            document.getElementById('toastMsg').innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function filterList(text, id) {
            document.querySelectorAll(`#${id} .equip-card`).forEach(c => {
                const title = c.querySelector('.equip-title').innerText.toLowerCase();
                c.style.display = title.includes(text.toLowerCase()) ? 'flex' : 'none';
            });
        }
    </script>
</body>
</html>